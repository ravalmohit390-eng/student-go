{% extends "base.html" %}

{% block title %}Notes Manager{% endblock %}

{% block content %}
<div class="notes-container">
    <!-- Top Action Bar -->
    <div class="notes-header-row">
        <div>
            <h3 class="mb-0">Your Notes</h3>
            <p class="text-muted mb-0">Manage and export your study materials</p>
        </div>
        <div class="d-flex gap-3 align-items-center">
            <div class="search-wrapper" style="position: relative;">
                <i class="fas fa-search"
                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem;"></i>
                <input type="text" id="searchTerm" class="form-control" placeholder="Search notes..."
                    style="padding-left: 35px; width: 220px; border-radius: 12px;">
            </div>
            <button class="btn btn-primary d-md-none"
                onclick="document.getElementById('newNoteCard').scrollIntoView({behavior: 'smooth'})">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <div class="row" style="display: flex; gap: 2rem; flex-wrap: wrap-reverse;">
        <!-- Notes List -->
        <div class="col-md-8" style="flex: 2; min-width: 320px;">
            <div class="notes-grid" id="notesList">
                {% for note in notes %}
                <div class="note-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h4>{{ note.title }}</h4>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light"
                                style="background: transparent; border: none; padding: 0.25rem 0.5rem;"
                                onclick="toggleActions(this)">
                                <i class="fas fa-ellipsis-v text-muted"></i>
                            </button>
                        </div>
                    </div>
                    <p>{{ note.content }}</p>

                    {% if note.filename %}
                    <div style="margin-bottom: 1.25rem;">
                        <a href="{{ url_for('main.uploaded_file', filename=note.filename) }}" target="_blank"
                            class="badge bg-light text-dark py-2 px-3 d-inline-flex align-items-center"
                            style="border-radius: 8px; font-weight: 500; font-size: 0.8rem; border: 1px solid var(--border-color); color: var(--text-color) !important;">
                            <i class="fas fa-paperclip me-2 text-primary" style="margin-right: 6px;"></i>
                            {{ note.filename[:20] + '...' if note.filename|length > 20 else note.filename }}
                        </a>
                    </div>
                    {% endif %}

                    <div class="note-meta">
                        <span><i class="far fa-calendar-alt me-1"></i> {{ note.date_posted.strftime('%d %b %Y')
                            }}</span>
                        <div class="note-actions">
                            <a href="{{ url_for('main.export_note_pdf', id=note.id) }}" class="btn btn-light btn-sm"
                                title="Export to PDF" target="_blank">
                                <i class="fas fa-file-pdf text-danger"></i>
                            </a>
                            <a href="{{ url_for('main.delete_note', id=note.id) }}" class="btn btn-light btn-sm"
                                title="Delete Note" onclick="return confirm('Permanently delete this note?')">
                                <i class="fas fa-trash text-muted"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card w-100 text-center py-5" style="border-style: dashed; border-width: 2px;">
                    <div class="card-body">
                        <i class="fas fa-sticky-note fa-4x text-muted mb-3 opacity-25"></i>
                        <p class="text-muted">You haven't created any notes yet. Start by using the form!</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Create Note Form -->
        <div class="col-md-4" style="flex: 1; min-width: 320px;" id="newNoteCard">
            <div class="card sticky-top" style="top: 2rem;">
                <div class="card-body">
                    <h3 class="h5 mb-4"><i class="fas fa-plus-circle text-primary me-2"></i> Create New Note</h3>
                    <form method="POST" action="{{ url_for('main.notes') }}" enctype="multipart/form-data">
                        <div class="form-group mb-3">
                            <label class="form-label">Note Title</label>
                            <input type="text" name="title" class="form-control" placeholder="e.g. Physics Chapter 1"
                                required>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Content</label>
                            <textarea name="content" class="form-control" rows="6" placeholder="Write your thoughts..."
                                required></textarea>
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label">Media Attachment</label>
                            <div class="file-upload-wrapper" style="position: relative;">
                                <input type="file" name="file" class="form-control"
                                    style="padding-top: 2.5rem; padding-bottom: 2.5rem; border-style: dashed; border-width: 2px; text-align: center; cursor: pointer;">
                                <div
                                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; text-align: center;">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                    <p class="small text-muted mb-0">Drag & Drop or Click to browse</p>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-3">
                            <i class="fas fa-save me-2"></i> Save Note
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Real-time Search Logic
    document.getElementById('searchTerm').addEventListener('keyup', function () {
        let filter = this.value.toUpperCase();
        let list = document.getElementById('notesList');
        let items = list.getElementsByClassName('note-item');

        for (let i = 0; i < items.length; i++) {
            let h4 = items[i].querySelector("h4");
            let p = items[i].querySelector("p");
            if (h4.innerHTML.toUpperCase().indexOf(filter) > -1 || p.innerHTML.toUpperCase().indexOf(filter) > -1) {
                items[i].style.display = "";
            } else {
                items[i].style.display = "none";
            }
        }
    });

    // Mobile specific: Hide header on scroll for better viewport usage
    window.addEventListener('scroll', function () {
        const topBar = document.querySelector('.top-bar');
        if (window.scrollY > 50) {
            topBar?.classList.add('shadow-sm');
        } else {
            topBar?.classList.remove('shadow-sm');
        }
    });
</script>
{% endblock %}